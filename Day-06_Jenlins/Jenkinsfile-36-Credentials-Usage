// Using Credentials in Pipeline
// Demonstrates various ways to use Jenkins credentials securely
//
// REQUIRED JENKINS PLUGINS:
// - Credentials Plugin (credentials)
// - Credentials Binding Plugin (credentials-binding)
// - SSH Agent Plugin (ssh-agent) - for SSH credentials
//
// ADDITIONAL SETUP:
// - Add credentials in Jenkins (Manage Jenkins > Manage Credentials)
// - Supported types: Username/Password, Secret Text, Secret File, SSH Private Key, Certificate
//
pipeline {
    agent any
    
    environment {
        // Method 1: Using credentials() helper in environment block
        // Returns username and password as separate variables
        DB_CREDS = credentials('database-credentials')  // Creates DB_CREDS_USR and DB_CREDS_PSW
        
        // Method 2: Secret text credential
        API_KEY = credentials('api-key-secret')  // Returns the secret value
        
        // Method 3: Secret file credential
        CONFIG_FILE = credentials('config-file')  // Returns path to temporary file
    }
    
    stages {
        stage('Using Username/Password Credentials') {
            steps {
                echo 'Demonstrating username/password credentials...'
                sh '''
                    # Access username and password separately
                    echo "Username: $DB_CREDS_USR"
                    # Password is masked in logs
                    echo "Connecting to database with credentials..."
                    # mysql -u $DB_CREDS_USR -p$DB_CREDS_PSW -h localhost mydb
                '''
            }
        }
        
        stage('Using Secret Text') {
            steps {
                echo 'Demonstrating secret text credentials...'
                sh '''
                    # API_KEY is automatically masked in logs
                    echo "Making API call with key..."
                    # curl -H "Authorization: Bearer $API_KEY" https://api.example.com/data
                '''
            }
        }
        
        stage('Using Secret File') {
            steps {
                echo 'Demonstrating secret file credentials...'
                sh '''
                    echo "Config file location: $CONFIG_FILE"
                    # Application can read the config file
                    # cat $CONFIG_FILE
                    # ./app --config $CONFIG_FILE
                '''
            }
        }
        
        stage('Using withCredentials - Username/Password') {
            steps {
                echo 'Using withCredentials for username/password...'
                withCredentials([usernamePassword(
                    credentialsId: 'database-credentials',
                    usernameVariable: 'DB_USER',
                    passwordVariable: 'DB_PASS'
                )]) {
                    sh '''
                        echo "User: $DB_USER"
                        # Password is masked
                        # mysql -u $DB_USER -p$DB_PASS -e "SHOW DATABASES;"
                    '''
                }
            }
        }
        
        stage('Using withCredentials - Secret Text') {
            steps {
                echo 'Using withCredentials for secret text...'
                withCredentials([string(
                    credentialsId: 'api-key-secret',
                    variable: 'API_TOKEN'
                )]) {
                    sh '''
                        # API_TOKEN is masked in logs
                        echo "Calling API..."
                        # curl -H "X-API-Key: $API_TOKEN" https://api.example.com
                    '''
                }
            }
        }
        
        stage('Using withCredentials - Secret File') {
            steps {
                echo 'Using withCredentials for secret file...'
                withCredentials([file(
                    credentialsId: 'config-file',
                    variable: 'MY_CONFIG'
                )]) {
                    sh '''
                        echo "Using config file at: $MY_CONFIG"
                        # cp $MY_CONFIG ./application.conf
                        # cat $MY_CONFIG
                    '''
                }
            }
        }
        
        stage('Using SSH Credentials') {
            steps {
                echo 'Using SSH credentials with sshagent...'
                sshagent(['ssh-private-key']) {
                    sh '''
                        # SSH key is available in this block
                        # ssh -o StrictHostKeyChecking=no user@server.com "uptime"
                        # scp file.txt user@server.com:/path/
                        # git clone git@github.com:org/private-repo.git
                        echo "SSH operations completed"
                    '''
                }
            }
        }
        
        stage('Multiple Credentials') {
            steps {
                echo 'Using multiple credentials together...'
                withCredentials([
                    usernamePassword(credentialsId: 'database-credentials', usernameVariable: 'DB_USER', passwordVariable: 'DB_PASS'),
                    string(credentialsId: 'api-key-secret', variable: 'API_KEY'),
                    file(credentialsId: 'config-file', variable: 'CONFIG')
                ]) {
                    sh '''
                        echo "Database user: $DB_USER"
                        echo "API key is set: [MASKED]"
                        echo "Config file available at: $CONFIG"
                        
                        # All credentials available here
                        # Deploy application with all configs
                    '''
                }
            }
        }
        
        stage('AWS Credentials Example') {
            steps {
                echo 'Using AWS credentials...'
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding', 
                     credentialsId: 'aws-credentials',
                     accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                     secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']
                ]) {
                    sh '''
                        # AWS credentials available as environment variables
                        # aws s3 ls
                        # aws ec2 describe-instances
                        echo "AWS operations completed"
                    '''
                }
            }
        }
        
        stage('Docker Registry Credentials') {
            steps {
                echo 'Using Docker registry credentials...'
                withCredentials([usernamePassword(
                    credentialsId: 'docker-hub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        # Login to Docker registry
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        
                        # Push/pull images
                        # docker push myimage:latest
                        # docker pull privateimage:latest
                        
                        # Logout
                        docker logout
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'Credentials demonstration completed'
            echo 'SECURITY TIP: Never hardcode credentials in Jenkinsfile!'
            echo 'SECURITY TIP: Always use credentials() or withCredentials()'
            echo 'SECURITY TIP: Credentials are automatically masked in console logs'
        }
        
        success {
            echo 'All credential operations completed successfully!'
        }
    }
}
